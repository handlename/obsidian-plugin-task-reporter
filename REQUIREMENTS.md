# 要件定義書: Obsidian Task Report Plugin

## プロジェクト概要

### 目的
Obsidianで管理しているタスクリストを、日報などの報告用フォーマットに整形し、クリップボードにコピーするプラグインを開発する。

### 背景
- 日次の作業報告をObsidianのノートから効率的に生成したい
- 特定のタグが付いたタスクのみを抽出し、報告用に整形する必要がある
- タスク本文の加工(タグ変換、リンク除去、URL整形など)により、外部ツールへの貼り付けに適した形式にする

### スコープ
- 現在開いているノートからのタスク抽出とフォーマット
- クリップボードへのコピー機能
- プラグイン設定画面の提供
- 対象範囲外: ノート間の集約、自動レポート生成、外部サービスとの連携

---

## ステークホルダー

| 役割 | 期待値 |
|------|--------|
| エンドユーザー | 日報作成を効率化し、手作業での整形作業を削減したい |
| 開発者 | 保守しやすく、拡張可能なコードベースを維持したい |

---

## 機能要件

### FR-001: ノート内タスクリストの抽出 [必須]
**根拠**: 日報生成の基本機能

**説明**: 現在開いているノート内の、指定された見出し配下にあるタスクリストを抽出する。

**詳細仕様**:
- 対象見出しは設定で指定可能(例: `## 今日やったこと`)
- Markdown形式のタスクリスト(`- [ ]`, `- [x]`など)を認識
- 見出し配下の全階層のタスクを取得

**検証基準**:
- 指定見出し配下のタスクリストをすべて抽出できること
- 他の見出し配下のタスクは抽出しないこと

---

### FR-002: タグによるフィルタリング [必須]
**根拠**: 報告対象タスクの選別

**説明**: 特定のタグが付いたタスク項目のみをフォーマット対象とする。

**詳細仕様**:
- 対象タグプレフィックスは設定で指定可能(例: `#work/`)
- 対象タグプレフィックスが付いていないタスクは除外
- 除外タグも設定可能(例: `#work/routine`は除外)

**検証基準**:
- 対象タグが付いたタスクのみが抽出されること
- 除外タグが付いたタスクは除外されること

---

### FR-003: サブアイテムのフィルタリング [必須]
**根拠**: 完了したサブタスクのみを報告

**説明**: タスクのサブアイテムのうち、特定のチェック文字でマークされたもののみをフォーマット対象とする。

**詳細仕様**:
- チェック文字は設定で指定可能(例: `*`, `x`)
- `- [*] サブタスク` の `*` 部分が対象チェック文字と一致するもののみ抽出
- 階層は最大レベル1まで(親タスクのレベルを0とする)

**検証基準**:
- 指定チェック文字のサブアイテムのみが出力されること
- レベル2以上のサブアイテムは出力されないこと

---

### FR-004: タグのフォーマット変換 [必須]
**根拠**: 報告用フォーマットへの整形

**説明**: タスク本文内のタグを、報告用の形式に変換する。

**詳細仕様**:
- 設定で指定されたプレフィックス(例: `#work/`)を除去
- `#work/sre` → `*sre*` のように、タグ名をイタリック体に変換
- プレフィックスに一致しないタグはそのまま残す

**検証基準**:
- 指定プレフィックス付きタグ(例: `#work/xxx`)が `*xxx*` に変換されること
- 他のタグ(例: `#personal`)は変更されないこと

---

### FR-005: 内部リンクの除去 [必須]
**根拠**: 報告文書での可読性向上

**説明**: Obsidian内部リンク(`[[link]]`形式および`[text](path.md)`形式)をリンクテキストのみに変換する。

**詳細仕様**:
- Markdown形式の内部リンク: `[プロジェクト詳細](2025/05/20250531_060210.md)` → `プロジェクト詳細`
- WikiLink形式の内部リンク: `[[プロジェクト詳細]]` → `プロジェクト詳細`
- エイリアス付きWikiLink: `[[2025/05/file|プロジェクト詳細]]` → `プロジェクト詳細`
- 外部リンク(`https://`で始まるもの)は残す

**検証基準**:
- Markdown形式の内部リンクがテキストのみに変換されること
- WikiLink形式の内部リンクがテキストのみに変換されること
- エイリアス付きWikiLinkはエイリアス部分のみが残ること
- 外部リンクはそのまま残ること

---

### FR-006: GitHub URL の整形 [必須]
**根拠**: Issue/PR参照の簡潔化

**説明**: GitHub の Issue/PR URL を、リポジトリ名と番号を含む簡潔な形式に変換する。

**詳細仕様**:
- `https://github.com/org/repo/issues/1234` → `[repo#1234](https://github.com/org/repo/issues/1234)`
- Pull Request(`/pulls/`)も同様に変換
- URLパラメータがある場合も対応

**検証基準**:
- GitHub の Issue/PR URL が指定形式に変換されること
- 他のURLは変更されないこと

---

### FR-007: タスクステータスに応じた装飾 [必須]
**根拠**: 視覚的な情報伝達

**説明**: タスクのステータスに応じて、適切な装飾を適用する。

**詳細仕様**:
- キャンセル済みタスク(`- [-]`など): テキストを `~text~` (取り消し線)で囲む
- キャンセル判定: 設定で指定されたチェック文字(デフォルト: `-`)と一致するタスク
- スケジュール項目: 設定で指定されたプレフィックス(デフォルト: `📅`)を先頭に追加
- スケジュール判定: タスク本文が設定で指定されたプレフィックスで始まる場合

**検証基準**:
- キャンセルタスクが取り消し線で表示されること
- スケジュールに絵文字が付くこと

---

### FR-008: 階層構造のインデント表現 [必須]
**根拠**: タスク階層の保持

**説明**: サブアイテムを適切なインデントで出力する。

**詳細仕様**:
- レベル0(親タスク): インデントなし
- レベル1(サブタスク): `    - ` (4スペース + ハイフン + スペース)

**検証基準**:
- レベル0はインデントなしで出力されること
- レベル1は4スペースのインデント付きで出力されること

---

### FR-009: クリップボードへのコピー [必須]
**根拠**: ユーザー利便性

**説明**: フォーマット済みテキストをクリップボードにコピーする。

**詳細仕様**:
- コマンドパレットまたはリボンボタンから実行
- コピー完了時に通知を表示

**検証基準**:
- クリップボードに正しくコピーされること
- コピー完了の通知が表示されること

---

### FR-010: エラーハンドリング [必須]
**根拠**: ユーザーへの適切なフィードバック

**説明**: 処理中にエラーが発生した場合、適切なメッセージをアラート表示する。

**詳細仕様**:
- 対象見出しが見つからない場合: 「指定された見出し『{見出し名}』が見つかりませんでした」とアラート表示
- タスクが1つも抽出できない場合: 「フォーマット対象のタスクが見つかりませんでした」とアラート表示
- その他のエラー: エラー内容を含むメッセージを表示

**検証基準**:
- 見出しが存在しない場合に適切なアラートが表示されること
- フォーマット対象タスクがゼロの場合に適切なアラートが表示されること
- エラーメッセージが具体的でわかりやすいこと

---

### FR-011: プラグイン設定画面 [必須]
**根拠**: カスタマイズ可能性の提供

**説明**: 以下のパラメータを設定画面で指定可能とする。

**設定項目**:
- 対象見出し(デフォルト: `## 今日やったこと`)
- 対象アイテムタグプレフィックス(デフォルト: `#work/`)
- 除外タグパターン(デフォルト: `#work/routine`)
- 対象サブアイテムのチェック文字(デフォルト: `k`)
- キャンセルタスクのチェック文字(デフォルト: `-`)
- スケジュールタスクのプレフィックス(デフォルト: `📅`)

**検証基準**:
- すべての設定項目が変更可能であること
- 設定変更がフォーマット処理に反映されること
- 設定がObsidianの設定ファイルに永続化されること

---

## 非機能要件

### NFR-001: 性能要件 [必須]
**説明**: フォーマット処理は、一般的なノートサイズ(1000行以内)に対して3秒以内に完了すること。

**検証基準**: 1000行のノートで処理時間を計測し、3秒以内であること

---

### NFR-002: 互換性要件 [必須]
**説明**: Obsidian API v1.0以降に対応すること。

**検証基準**:
- Obsidian v1.0以降で動作すること
- 公式APIのみを使用し、非公開APIに依存しないこと

---

### NFR-003: 保守性要件 [推奨]
**説明**: コードの保守性を確保する。

**詳細**:
- TypeScriptで実装
- 関数は原則として純粋関数とする(副作用を最小化)
- 単体テストカバレッジ80%以上
- 冗長なコメントは禁止、意図を補足するコメントのみ記述

**検証基準**:
- テストカバレッジが80%以上であること
- ESLintエラーがゼロであること

---

### NFR-004: セキュリティ要件 [推奨]
**説明**: ユーザーデータの安全性を確保する。

**詳細**:
- ノート内容の外部送信は行わない
- すべての処理はローカルで完結
- 設定情報は平文で保存(秘匿情報は含まない前提)

**検証基準**:
- ネットワーク通信が発生しないこと
- コードレビューでセキュリティリスクが指摘されないこと

---

### NFR-005: ユーザビリティ要件 [推奨]
**説明**: 使いやすいインターフェースを提供する。

**詳細**:
- コマンドパレットから実行可能
- リボンアイコンから1クリックで実行可能(オプション)
- エラー発生時は、わかりやすいメッセージを表示

**検証基準**:
- ユーザーが3ステップ以内で機能を実行できること
- エラーメッセージが具体的であること

---

## 制約条件

### 技術スタック
- **言語**: TypeScript
- **プラットフォーム**: Obsidian Plugin API
- **ビルドツール**: esbuild (Obsidianプラグインの標準)
- **テスティング**: Jest

### 開発環境
- Node.js v18以降
- npm v9以降

### 前提条件
- ユーザーはObsidianをインストール済み
- ノートはMarkdown形式で記述されている
- タスクリストはMarkdown標準の `- [ ]` 形式

---

## 依存関係

### 機能要件の依存関係
```
FR-001 (タスク抽出)
  ├── FR-002 (タグフィルタリング)
  ├── FR-003 (サブアイテムフィルタリング)
  └── FR-008 (インデント表現)

FR-004 (タグ変換)
FR-005 (内部リンク除去)
FR-006 (GitHub URL整形)
FR-007 (ステータス装飾)
  ↓
FR-009 (クリップボードコピー)
  ↓
FR-010 (エラーハンドリング)

FR-011 (設定画面) → すべての機能要件に影響
```

---

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Obsidian APIの破壊的変更 | 高 | 公式APIのみ使用、バージョン固定 |
| Markdown形式の多様性 | 中 | 標準形式のみサポート、エッジケースは仕様外と明記 |
| 大容量ノートでの性能劣化 | 中 | 対象見出し配下のみ処理、必要に応じて警告表示 |
